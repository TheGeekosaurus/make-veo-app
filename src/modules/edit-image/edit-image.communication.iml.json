{
    "url": "/models/{{parameters.model}}:generateContent",
    "method": "POST",
    "body": {
        "contents": [
            {
                "parts": "{{flatten(array(object('text', parameters.prompt), map(parameters.referenceImages, 'object', 'inline_data', object('mime_type', item.mimeType, 'data', item.data))))}}"
            }
        ],
        "generationConfig": {
            "responseModalities": [
                "TEXT",
                "IMAGE"
            ],
            "imageConfig": {
                "aspectRatio": "{{ifempty(parameters.aspectRatio, undefined)}}",
                "imageSize": "{{ifempty(parameters.imageSize, undefined)}}"
            }
        }
    },
    "response": {
        "output": {
            "text": "{{ifempty(body.candidates[0].content.parts[0].text, '')}}",
            "imageMimeType": "{{ifempty(body.candidates[0].content.parts[1].inlineData.mimeType, body.candidates[0].content.parts[0].inlineData.mimeType)}}",
            "imageData": "{{ifempty(body.candidates[0].content.parts[1].inlineData.data, body.candidates[0].content.parts[0].inlineData.data)}}",
            "finishReason": "{{body.candidates[0].finishReason}}",
            "promptTokenCount": "{{body.usageMetadata.promptTokenCount}}",
            "totalTokenCount": "{{body.usageMetadata.totalTokenCount}}"
        }
    }
}
